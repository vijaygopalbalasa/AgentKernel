# Prometheus Alerting Rules for AgentRun
# Deploy with: kubectl apply -f alerting-rules.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: agentrun-alerts
  namespace: agentrun
  labels:
    app.kubernetes.io/part-of: agentrun
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
    - name: agentrun.gateway
      interval: 30s
      rules:
        # High error rate across all gateway pods
        - alert: HighErrorRate
          expr: rate(agent_os_errors_total[5m]) > 0.1
          for: 5m
          labels:
            severity: critical
            component: gateway
          annotations:
            summary: "High error rate detected on AgentRun gateway"
            description: "Error rate is {{ $value | printf \"%.2f\" }} errors/sec (threshold: 0.1) for the last 5 minutes."

        # High p95 latency for agent tasks
        - alert: HighLatency
          expr: histogram_quantile(0.95, rate(agent_os_task_duration_seconds_bucket[5m])) > 5
          for: 10m
          labels:
            severity: warning
            component: gateway
          annotations:
            summary: "High p95 latency on AgentRun gateway"
            description: "p95 latency is {{ $value | printf \"%.1f\" }}s (threshold: 5s) for the last 10 minutes."

        # High memory usage per pod
        - alert: HighMemoryUsage
          expr: container_memory_rss{container="gateway", namespace="agentrun"} > 1.5e+9
          for: 5m
          labels:
            severity: warning
            component: gateway
          annotations:
            summary: "Gateway pod memory usage above 1.5Gi"
            description: "Pod {{ $labels.pod }} RSS is {{ $value | humanize1024 }}B."

        # Circuit breaker open (LLM provider failing)
        - alert: CircuitBreakerOpen
          expr: agent_os_circuit_breaker_state{state="open"} > 0
          for: 1m
          labels:
            severity: warning
            component: gateway
          annotations:
            summary: "Circuit breaker open for {{ $labels.name }}"
            description: "The circuit breaker for {{ $labels.name }} has been open for over 1 minute, indicating upstream failures."

    - name: agentrun.database
      interval: 30s
      rules:
        # Database unhealthy
        - alert: DatabaseDown
          expr: agent_os_database_healthy == 0
          for: 1m
          labels:
            severity: critical
            component: database
          annotations:
            summary: "AgentRun database is down"
            description: "The PostgreSQL database has been unreachable for over 1 minute."

        # Database connection pool exhaustion
        - alert: DatabasePoolExhausted
          expr: agent_os_database_pool_available / agent_os_database_pool_size < 0.1
          for: 5m
          labels:
            severity: warning
            component: database
          annotations:
            summary: "Database connection pool nearly exhausted"
            description: "Less than 10% of database connections are available ({{ $value | printf \"%.0f\" }}%)."

    - name: agentrun.redis
      interval: 30s
      rules:
        # Redis/EventBus unhealthy
        - alert: RedisDown
          expr: agent_os_event_bus_healthy == 0
          for: 1m
          labels:
            severity: critical
            component: redis
          annotations:
            summary: "AgentRun Redis event bus is down"
            description: "The Redis event bus has been disconnected for over 1 minute."

    - name: agentrun.agents
      interval: 60s
      rules:
        # Too many agent errors
        - alert: AgentErrorThreshold
          expr: sum(rate(agent_os_agent_errors_total[10m])) by (agent_id) > 0.05
          for: 5m
          labels:
            severity: warning
            component: agents
          annotations:
            summary: "Agent {{ $labels.agent_id }} has high error rate"
            description: "Agent {{ $labels.agent_id }} is producing {{ $value | printf \"%.3f\" }} errors/sec over the last 10 minutes."

        # Agent stuck in starting state
        - alert: AgentStuckStarting
          expr: agent_os_agent_state{state="starting"} > 0
          for: 5m
          labels:
            severity: warning
            component: agents
          annotations:
            summary: "Agent {{ $labels.agent_id }} stuck in starting state"
            description: "Agent has been in 'starting' state for over 5 minutes."
